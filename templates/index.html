<!DOCTYPE html>
<html>
<head>
    <title>Factory Order Entry</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
        .container { flex: 1; padding: 20px; }
        .header, .footer { background-color: #0066FF; color: white; padding: 15px 20px; text-align: center; }
        h2 { text-align: center; color: #2c3e50; }
        form { max-width: 600px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        label { font-weight: 600; display: block; margin-top: 15px; color: #2c3e50; }
        input[type="text"], input[type="number"], input[type="date"], select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus { border-color: #3498db; outline: none; }
        input[type="radio"] { margin-right: 8px; margin-top: 10px; }
        button { width: 100%; padding: 12px; background-color: #27ae60; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 25px; transition: background 0.3s; }
        button:hover { background-color: #219150; }
        a { display: block; text-align: center; margin-top: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }
        .hidden { display: none; }
        .section { margin: 10px 0; padding: 15px; border: 1px solid #e0e0e0; background-color: #fafafa; border-radius: 4px; }
        small { color: #7f8c8d; }
        h3 { margin-top: 0; color: #0066FF; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .next-btn { background-color: #3498db; width: 100%; padding: 12px; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 15px; transition: background 0.3s; }
        .next-btn:hover { background-color: #2980b9; }
    </style>
    <script>
        var savedState = {{ (order['state'] if order else '') | tojson }};
        var savedCity = {{ (order['city'] if order else '') | tojson }};

        async function loadStates(countryName) {
            try {
                const response = await fetch('https://countriesnow.space/api/v0.1/countries/states', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ country: countryName })
                });
                const data = await response.json();
                if (data.error) return;

                const stateSelect = document.getElementsByName("state")[0];
                stateSelect.innerHTML = '<option value="">Select State</option>';
                
                if (data.data && data.data.states) {
                    data.data.states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state.name;
                        option.text = state.name;
                        stateSelect.add(option);
                    });
                }

                if (savedState) {
                    stateSelect.value = savedState;
                    if (stateSelect.value === savedState) {
                        loadCities(countryName, savedState);
                        savedState = null;
                    }
                }
            } catch (error) {
                console.error('Error loading states:', error);
            }
        }

        async function loadCities(countryName, stateName) {
            try {
                const response = await fetch('https://countriesnow.space/api/v0.1/countries/state/cities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ country: countryName, state: stateName })
                });
                const data = await response.json();
                if (data.error) return;

                const stateSelect = document.getElementsByName("state")[0];
                if (stateSelect.value !== stateName) return;

                const citySelect = document.getElementsByName("city")[0];
                citySelect.innerHTML = '<option value="">Select City</option>';
                
                if (data.data) {
                    data.data.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.text = city;
                        citySelect.add(option);
                    });
                }

                if (savedCity) {
                    citySelect.value = savedCity;
                    if (citySelect.value === savedCity) {
                        savedCity = null;
                    }
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        window.onload = function() {
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var yyyy = today.getFullYear();
            
            // Allow 1 week fill back (7 days ago)
            var pastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            var dd_pw = String(pastWeek.getDate()).padStart(2, '0');
            var mm_pw = String(pastWeek.getMonth() + 1).padStart(2, '0');
            var yyyy_pw = pastWeek.getFullYear();
            var minDate = yyyy_pw + '-' + mm_pw + '-' + dd_pw;

            var dateInput = document.getElementsByName("delivery_date")[0];
            if(dateInput) { dateInput.min = minDate; }

            // Load States for India immediately
            loadStates("India");

            // Event Listeners
            var stateSelect = document.getElementsByName("state")[0];

            stateSelect.addEventListener('change', function() {
                loadCities("India", this.value);
                document.getElementsByName("city")[0].innerHTML = '<option value="">Select City</option>';
            });

            // Pincode Auto-fill
            var pincodeInput = document.getElementsByName("pincode")[0];
            pincodeInput.addEventListener('blur', async function() {
                var pincode = this.value;
                var iso2 = 'IN'; // Fixed to India
                var countryName = "India";

                if (pincode && iso2) {
                    try {
                        const response = await fetch(`https://api.zippopotam.us/${iso2}/${pincode}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.places && data.places.length > 0) {
                                const place = data.places[0];
                                const apiCity = place['place name'];
                                const apiState = place['state'];

                                
                                var stateSelect = document.getElementsByName("state")[0];
                                var stateFound = false;
                                for (var i = 0; i < stateSelect.options.length; i++) {
                                    if (stateSelect.options[i].text.toLowerCase() === apiState.toLowerCase()) {
                                        stateSelect.selectedIndex = i;
                                        stateFound = true;
                                        break;
                                    }
                                }

                                if (stateFound) {
                                    await loadCities(countryName, stateSelect.value);
                                    var citySelect = document.getElementsByName("city")[0];
                                    for (var i = 0; i < citySelect.options.length; i++) {
                                        if (citySelect.options[i].text.toLowerCase() === apiCity.toLowerCase()) {
                                            citySelect.selectedIndex = i;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    } catch (e) { console.error("Auto-fill error", e); }
                }
            });
        }

        function validateAndShowNext(currentId, nextId) {
            var section = document.getElementById(currentId);
            var inputs = section.querySelectorAll("input, select");
            var valid = true;
            for (var i = 0; i < inputs.length; i++) {
                if (!inputs[i].checkValidity()) {
                    inputs[i].reportValidity();
                    valid = false;
                    break;
                }
            }
            if (valid) {
                document.getElementById(nextId).classList.remove("hidden");
                var btn = section.querySelector(".next-btn");
                if (btn) btn.style.display = "none";
            }
        }
    </script>
</head>
<body>

<div class="header">
    <h1>Factory Order Management</h1>
</div>

<div class="container">

<h2>{% if order %}Edit Order #{{ order['order_id'] }}{% else %}New Customer Order{% endif %}</h2>

<form action="{{ '/update_order' if order else '/submit_order' }}" method="POST">

    {% if order %}
    <div class="section">
        <h3>Order Info</h3>
        <label>Order ID:</label>
        <input type="text" value="{{ order['order_id'] }}" readonly style="background-color: #eee;">
        <input type="hidden" name="order_id" value="{{ order['order_id'] }}">
        <label>Customer ID:</label>
        <input type="text" value="{{ order['customer_id'] }}" readonly style="background-color: #eee;">
        
        <label>Order Status:</label>
        <select name="status">
            <option value="Order placed" {% if order['status'] == 'Order placed' %}selected{% endif %}>Order placed</option>
            <option value="Processing" {% if order['status'] == 'Processing' %}selected{% endif %}>Processing</option>
            <option value="Quotation approved" {% if order['status'] == 'Quotation approved' %}selected{% endif %}>Quotation approved</option>
            <option value="Ready for dispatch" {% if order['status'] == 'Ready for dispatch' %}selected{% endif %}>Ready for dispatch</option>
            <option value="In transit" {% if order['status'] == 'In transit' %}selected{% endif %}>In transit</option>
            <option value="Delivered/installed" {% if order['status'] == 'Delivered/installed' %}selected{% endif %}>Delivered/installed</option>            
            <option value="Settled" {% if order['status'] == 'Settled' %}selected{% endif %}>Settled</option>
            <option value="Closed" {% if order['status'] == 'Closed' %}selected{% endif %}>Closed</option>
            <option value="Cancelled" {% if order['status'] == 'Cancelled' %}selected{% endif %}>Cancelled</option>
        </select>

        <label>Advance Amount Paid:</label>
        <input type="number" step="0.01" min="0" name="advance_paid" value="{{ order['advance_paid'] if order else '0' }}">
    </div>
    {% endif %}

    <div id="customer-section" class="section">
    <h3>Customer Details</h3>
    <label>Name:</label><br>
    <input type="text" name="name" value="{{ order['name'] if order else '' }}" required><br><br>

    <label>Mobile Number:</label><br>
    <input type="text" name="mobile" value="{{ order['mobile'] if order else '' }}" required><br><br>

        <label><strong>Address Details:</strong></label>
        <label>Street Address:</label>
        <textarea name="address" rows="2" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" required>{{ order['address'] if order else '' }}</textarea>

        <label>Pincode:</label>
        <input type="text" name="pincode" value="{{ order['pincode'] if order else '' }}" required>

        <label>State:</label>
        <select name="state" required><option value="">Select State</option></select>

        <label>City:</label>
        <select name="city" required><option value="">Select City</option></select>

        <label>Country:</label>
        <input type="text" name="country" value="India" readonly style="background-color: #eee;">

        {% if not order %}
        <button type="button" class="next-btn" onclick="validateAndShowNext('customer-section', 'order-section')">Next: Order Details</button>
        {% endif %}
    </div>

    <div id="order-section" class="section {% if not order %}hidden{% endif %}">
    <h3>Order Requirements</h3>
    <label><strong>Order Type:</strong></label><br>
    <input type="radio" name="order_type" value="Material Purchase" {% if not order or order['order_type'] == 'Material Purchase' %}checked{% endif %}> Direct Sales (Material Only)<br>
    <input type="radio" name="order_type" value="Fencing Contract Job" {% if order and order['order_type'] == 'Fencing Contract Job' %}checked{% endif %}> Fencing Contract (Full Job)<br><br>

    <!-- Common Details (Acres & Soil) -->
    <label>Acres of Land:</label><br>
    <input type="number" step="0.01" min="0" name="acres" id="acres" value="{{ order['acres'] if order else '' }}"><br><br>

    <label>Number of Units:</label><br>
    <input type="number" min="0" name="no_of_units" id="no_of_units" value="{{ order['no_of_units'] if order else '' }}"><br><br>

    <label>Soil Type:</label><br>
    <select name="soil_type">
        <option value="Normal" {% if order and order['soil_type'] == 'Normal' %}selected{% endif %}>Normal Soil</option>
        <option value="Rocky" {% if order and order['soil_type'] == 'Rocky' %}selected{% endif %}>Rocky (Hard)</option>
        <option value="Clay" {% if order and order['soil_type'] == 'Clay' %}selected{% endif %}>Clay (Soft)</option>
    </select><br><br>

    {% if not order %}
    <button type="button" class="next-btn" onclick="validateAndShowNext('order-section', 'product-section')">Next: Product Details</button>
    {% endif %}
    </div>

    <div id="product-section" class="section {% if not order %}hidden{% endif %}">
    <h3>Product Details</h3>
    <label>Product Type:</label><br>
    <select name="product_type" required>
        <option value="Chain Link" {% if order and order['product_type'] == 'Chain Link' %}selected{% endif %}>Chain Link</option>
        <option value="Barbed Wire" {% if order and order['product_type'] == 'Barbed Wire' %}selected{% endif %}>Barbed Wire</option>
    </select><br><br>

    <label>Product Material:</label><br>
    <select name="product_material" required>
        <option value="Galvanized Iron (GI)" {% if order and order['product_material'] == 'Galvanized Iron (GI)' %}selected{% endif %}>Galvanized Iron (GI)</option>
        <option value="PVC Coated" {% if order and order['product_material'] == 'PVC Coated' %}selected{% endif %}>PVC Coated</option>
        <option value="Stainless Steel" {% if order and order['product_material'] == 'Stainless Steel' %}selected{% endif %}>Stainless Steel</option>
    </select><br><br>

    <label>Product Dimension:</label><br>
    <select name="dimension" required>
        <option value="4ft Standard" {% if order and order['dimension'] == '4ft Standard' %}selected{% endif %}>4ft Standard</option>
        <option value="5ft Heavy" {% if order and order['dimension'] == '5ft Heavy' %}selected{% endif %}>5ft Heavy</option>
        <option value="6ft Premium" {% if order and order['dimension'] == '6ft Premium' %}selected{% endif %}>6ft Premium</option>
        <option value="8 Gauge Industrial" {% if order and order['dimension'] == '8 Gauge Industrial' %}selected{% endif %}>8 Gauge Industrial</option>
        <option value="Custom Special" {% if order and order['dimension'] == 'Custom Special' %}selected{% endif %}>Custom Special</option>
    </select><br><br>

    <label>Requested Delivery Date:</label><br>
    <input type="date" name="delivery_date" value="{{ order['delivery_date'] if order else '' }}" required><br><br>

    <button type="submit">{% if order %}Update Order{% else %}Submit Order{% endif %}</button>
    </div>

</form>

<br>
<a href="/orders">View Orders</a>

</div>

<div class="footer">
    <p>&copy; 2026 Rishaban Sivaramakrishnan</p>
</div>

</body>
</html>
